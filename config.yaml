version: 2.1

orbs:

  aws-cli: circleci/aws-cli@1.1.0

jobs:

  build:

    docker:

      - image: hashicorp/terraform:1.0.0

    steps:

      - checkout

      - run:

          name: Detect Changed Directory

          command: |

            CHANGED_DIR=$(git diff --name-only $CIRCLE_SHA1..$CIRCLE_SHA1~1 | grep '/' | cut -d'/' -f1 | uniq)

            if [ -n "$CHANGED_DIR" ]; then

              echo "Changed directory: $CHANGED_DIR"

              echo "export TF_WORKING_DIR=$CHANGED_DIR" >> $BASH_ENV

            else

              echo "No changes detected in any directory."

              exit 0

            fi

      - run:

          name: Configure AWS Credentials

          command: |

            echo "[default]" >> ~/.aws/credentials

            echo "aws_access_key_id=${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials

            echo "aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials

      - run:

          name: Initialize Terraform

          command: terraform init $TF_WORKING_DIR

      - run:

          name: Validate Code

          command: terraform validate

      - run:

          name: Format Code

          command: terraform fmt

      - run:

          name: Terraform Plan

          command: terraform plan

workflows:

  version: 2

  build-and-plan:

    jobs:

      - build
