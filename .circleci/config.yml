version: 2.1

jobs:
  build:
    docker:
      - image: hashicorp/terraform:1.0.0

    steps:
      - checkout

      - run:
          name: Detect Changed Directory
          command: |
            CHANGED_DIR=$(git diff --name-only $CIRCLE_SHA1..$CIRCLE_SHA1~1 | grep '/' | cut -d'/' -f1 | uniq)
            if [ -n "$CHANGED_DIR" ]; then
              echo "Changed directory: $CHANGED_DIR"
              echo "export TF_WORKING_DIR=$CHANGED_DIR" >> $BASH_ENV
            else
              echo "No changes detected in any directory."
              exit 0
            fi

      - run:
          name: Initialize Terraform
          command: terraform init $TF_WORKING_DIR
      - run:
          name: validate code
          command: terraform validate
      - run:
          name: fmt 
          command: terraform fmt
          

workflows:
  version: 2
  build-and-plan:
    jobs:
      - build
